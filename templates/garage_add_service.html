{% extends "base.html" %}
{% block content %}
  <div class="p-3 bg-white rounded shadow">
    <h4>Vehicle History for VIN: {{ vin }}</h4>

    <h5 class="mt-3">Global Events (from main chain)</h5>
    {% if data.global_events %}
      <ul class="list-group mb-3">
        {% for ev in data.global_events %}
          <li class="list-group-item">
            <div><strong>Block:</strong> {{ ev.block_index }} — <strong>TX:</strong> {{ ev.tx_id }}</div>
            <div><strong>Type:</strong> {{ ev.type }}</div>
            <div><strong>Payload:</strong> {{ ev.payload }}</div>
            <div><strong>When:</strong> {{ ev.timestamp }}</div>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <div class="alert alert-secondary">No global events found for this VIN.</div>
    {% endif %}

    <h5 class="mt-3">Vehicle-specific Chain (Service Records)</h5>
    {% if data.vehicle_chain.chain %}
      <div class="accordion" id="vchain">
        {% for block in data.vehicle_chain.chain %}
          <div class="accordion-item">
            <h2 class="accordion-header" id="h{{ loop.index }}">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#c{{ loop.index }}">
                Block #{{ block.index }} — Hash: {{ block.hash[:20] }}...
              </button>
            </h2>
            <div id="c{{ loop.index }}" class="accordion-collapse collapse" data-bs-parent="#vchain">
              <div class="accordion-body">
                <p><strong>Index:</strong> {{ block.index }}</p>
                <p><strong>Timestamp:</strong> {{ block.timestamp }}</p>
                <p><strong>Previous Hash:</strong> {{ block.previous_hash[:30] }}...</p>
                <p><strong>Nonce:</strong> {{ block.nonce }}</p>
                <p><strong>Transactions:</strong></p>
                <ul>
                {% for txr in block.transactions %}
                  <li>
                    <strong>{{ txr.tx.type if txr.tx.type else txr.tx['type'] }}</strong> —
                    {{ txr.tx.payload if txr.tx.payload else txr.tx['payload'] }}
                    <div><small>TX ID: {{ txr.tx_id }}</small></div>
                  </li>
                {% endfor %}
                </ul>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="alert alert-secondary">No service-record chain exists for this VIN yet.</div>
    {% endif %}
  </div>
{% endblock %}

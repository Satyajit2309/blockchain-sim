{% extends "base.html" %}
{% block content %}

<style>
  /* Container for the horizontal chain */
  .chain-visualization-container {
    display: flex;
    align-items: stretch; /* Make blocks same height */
    overflow-x: auto;   /* Allow horizontal scrolling */
    padding: 20px 10px;
    background-color: #f8f9fa; /* Light grey background */
    border-radius: 8px;
    border: 1px solid #dee2e6;
  }

  /* Represents the "link" or "arrow" between blocks */
  .chain-connector {
    flex: 0 0 40px; /* Fixed width for the connector */
    align-self: center; /* Center the arrow vertically */
    text-align: center;
    font-size: 2rem;  /* Make arrow bigger */
    color: #0d6efd;   /* Bootstrap primary blue */
    font-weight: bold;
  }

  /* A single block in the chain */
  .chain-block {
    flex: 0 0 320px; /* Fixed width for each block */
    border: 1px solid #adb5bd;
    border-radius: 8px;
    background-color: #fff;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    display: flex;
    flex-direction: column; /* Stack content vertically */
  }
  
  .chain-block .card-header {
    background-color: #e9ecef;
    border-bottom: 1px solid #adb5bd;
    font-weight: bold;
  }
  
  .chain-block .card-body {
    padding: 1rem;
    font-size: 0.9rem;
    flex-grow: 1; /* Allow body to fill space */
  }
  
  .chain-block .card-body p {
    margin-bottom: 0.5rem;
    word-wrap: break-word; /* Break long strings like hashes */
  }

  /* Special style for the first block (Genesis) */
  .chain-block.genesis-block .card-header {
    background-color: #d1e7dd; /* Bootstrap success-light */
    border-color: #a3cfbb;
  }
</style>
<div class="p-3 bg-white rounded shadow">
    <h4>Vehicle History for VIN: <span class="badge bg-primary">{{ vin }}</span></h4>

    <h5 class="mt-4">üìã Registration & Ownership (Global Chain)</h5>
    {% if data.global_events %}
      <ul class="list-group mb-3">
        {% for ev in data.global_events %}
          <li class="list-group-item">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <strong class="badge bg-info">{{ ev.type }}</strong>
                <div class="mt-2">
                  {% if ev.type == 'register_vehicle' %}
                    <strong>Owner:</strong> {{ ev.payload.owner }}<br>
                    <strong>Registered by:</strong> {{ ev.payload.meta.submitted_by }}
                  {% else %}
                    {{ ev.payload }}
                  {% endif %}
                </div>
              </div>
              <small class="text-muted">
                Block #{{ ev.block_index }}<br>
                {{ ev.timestamp|int }}
              </small>
            </div>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <div class="alert alert-secondary">No registration records found for this VIN in the global chain.</div>
    {% endif %}

    
    <h5 class="mt-4">üîß Service Records (Vehicle-Specific Chain)</h5>
    
    {% if data.vehicle_chain.chain and data.vehicle_chain.chain|length > 0 %}
      <div class="chain-visualization-container">
        
        {% for block in data.vehicle_chain.chain %}
          <div class="chain-block card {% if block.index == 0 %}genesis-block{% endif %}">
            <div class="card-header">
              {% if block.index == 0 %}
                Genesis Block
              {% else %}
                Block #{{ block.index }}
              {% endif %}
            </div>
            <div class="card-body">
              <p><strong>Hash:</strong><br><code>{{ block.hash[:20] }}...</code></p>
              <p><strong>Prev. Hash:</strong><br><code>{{ block.previous_hash[:20] }}...</code></p>
              <p><strong>Timestamp:</strong><br>{{ block.timestamp|int }}</p>
              <p><strong>Nonce:</strong> {{ block.nonce }}</p>
              
              {% if block.index > 0 %}
                <hr>
                <strong>Service Records:</strong>
                <div class="list-group list-group-flush">
                {% for txr in block.transactions %}
                  <div class="list-group-item px-0 py-1">
                      <span class="badge bg-success">{{ txr.tx.type }}</span>
                      <p class="mb-0 small">
                        <strong>Garage:</strong> {{ txr.tx.payload.garage }}<br>
                        <strong>Service:</strong> {{ txr.tx.payload.description }}
                      </p>
                  </div>
                {% endfor %}
                </div>
              {% endif %}
            </div>
          </div>

          {% if not loop.last %}
            <div class="chain-connector">
              ‚Üí
            </div>
          {% endif %}

        {% endfor %}
      </div>
    {% else %}
      <div class="alert alert-secondary">
        No service record chain (including Genesis) exists for this vehicle yet.
      </div>
    {% endif %}
    <div class="mt-4">
      <a href="{{ url_for('explorer') }}" class="btn btn-secondary">‚Üê Back to Explorer</a>
    </div>
  </div>
{% endblock %}